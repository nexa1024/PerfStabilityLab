# Week 2：Perfetto/System Trace 入门强化 + 哈希（minSdk 26）

> 本周目标：把 “抓 trace → 定位主线程慢点 → 写证据” 变成固定动作；并把卡顿的最基础三类（主线程阻塞/IO/锁等待）做成标准实验。  
> 本周交付：3 个可复现实验（每个都有复现/证据/规避/回归描述）+《Perfetto 最小读法清单》。

---

## 每日固定配方（90 分钟）

- 15m 算法：哈希/计数/映射类 1 题
- 45m 阅读 + 笔记：Perfetto/System Trace 基本概念 + 读图顺序
- 25m Demo：做“可控复现 + trace 可见证据”
- 5m 输出：卡片 1 张

---

## Day 1：Perfetto 抓取与界面熟悉

- 算法：两数之和/字母异位词计数等哈希题 1 道。
- 阅读笔记：写《Perfetto 我先看什么》
  - 先找主线程（UI Thread）轨道
  - 再找长 slice（>16ms、>50ms、>200ms）对应的 section
  - 最后回到代码（section 命名→按钮触发→日志落盘）
- Demo：
  - 在 `JankLab` 加“写入操作提示”：如何开始抓 System Trace（把步骤写进日志区）。
  - 给你现在已有的 trace section 命名做一次规范化（统一 `Lab#动作#细节`）。
- 输出卡片：《Perfetto 三步读法》。

验收：你能独立抓到一次 trace，并在 UI 线程上找到你自己打的 section。

---

## Day 2：实验 1 — 主线程阻塞（对照：同步 vs 异步）

- 算法：哈希计数题 1 道（写清 key 设计与边界）。
- 阅读笔记：写《主线程为什么不能做耗时》
  - 事件循环/Choreographer 帧调度直觉（不需深究源码）
- Demo：
  - `JankLab`
    - 复现：`Thread.sleep(200)`（trace section 包裹）
    - 修复：把耗时搬到后台线程/协程（例如 `Dispatchers.Default`），主线程只更新 UI
    - 验证：再抓 trace（或至少比较 section 出现线程变化/时长变化）并写入日志区
- 输出卡片：《同步→异步修复的证据怎么写》。

验收：能写出“复现前后差异”的证据描述（线程/时长/现象）。

---

## Day 3：实验 2 — 主线程 IO（对照：缓存/后台）

- 算法：去重/映射题 1 道。
- 阅读笔记：写《IO 卡顿常见来源》
  - 文件读写、数据库、SharedPreferences、日志过量等
- Demo：
  - 新增 `IoJankLab`（或复用 `JankLab` 的第二个场景）
    - 复现：主线程执行一段可控文件写入（比如写 5–20MB，注意控制体量）
    - 修复：后台线程执行 + 主线程显示进度/结果
    - 验证：trace/Profiler 观察主线程不再被长时间占用
- 输出卡片：《IO 卡顿：复现点与修复点》。

验收：能在 trace/Profiler 里看到主线程被 IO 占用的证据，并能说明修复后变化。

---

## Day 4：实验 3 — 锁等待（对照：锁粒度/避免主线程等待）

- 算法：哈希综合题 1 道。
- 阅读笔记：写《锁等待卡顿直觉》
  - 主线程等待锁/等待后台返回，本质就是“主线程停住”
- Demo：
  - 新增 `LockJankLab`
    - 复现：后台线程持有锁一段时间，主线程尝试获取同一把锁导致阻塞（trace section 包裹主线程获取锁部分）
    - 修复：避免主线程竞争该锁（例如把共享状态改成消息传递、或缩小锁范围、或改用无锁结构——先做到“主线程不等锁”即可）
    - 验证：trace 显示主线程 section 缩短/消失
- 输出卡片：《锁等待：如何写证据》。

验收：能清晰描述“主线程为什么在等锁、锁是谁持有”的证据链。

---

## Day 5：整理《Perfetto 最小读法清单》（可复用）

- 算法：错题复盘 1 题（把错因写成“下次避免”的规则）。
- 阅读笔记：将 Week2 的 Perfetto 笔记压缩成 1 页 checklist（抓取→定位→回到代码）。
- Demo：
  - 把 3 个实验页的 section 命名统一、日志格式统一、落盘字段统一。
  - 给每个实验页“验证”按钮增加：把本次验证结论写成 2 行总结（用于周复盘）。
- 输出卡片：《我的 Perfetto Checklist》。

验收：你能照着 checklist，从“我感觉卡”走到“我看到证据并写下来”。

---

## Day 6：周复盘（固化 3 个标准实验）

- 算法：补一题你本周最弱哈希模型（计数/映射/去重任选）。
- 阅读笔记：输出《Week2：卡顿基础三件套》一页纸（主线程阻塞/IO/锁等待）。
- Demo：
  - 确保 3 个实验都满足：复现稳定、证据可见、修复可切换、验证有文字结论。
- 输出卡片：《Week2 我能复现并证明的 3 类卡顿》。

本周验收：你随时能打开 Demo，5 分钟内复现其中任意一种卡顿，并拿到可解释的证据。

